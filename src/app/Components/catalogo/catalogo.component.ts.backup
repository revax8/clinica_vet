import { Component, OnInit, HostListener, OnDestroy } from '@angular/core';
import { ActivatedRoute, Router, RouterLink } from '@angular/router';
import { CommonModule } from '@angular/common';
import { CatalogoService, Producto, ProductosPorCategoria } from '../../Services/catalogo.service';
import { Subscription } from 'rxjs';

@Component({
  selector: 'app-catalogo',
  standalone: true,
  imports: [CommonModule, RouterLink],
  templateUrl: './catalogo.component.html',
  styleUrl: './catalogo.component.css'
})
export class CatalogoComponent implements OnInit, OnDestroy {
  categoria: string = '';
  productos: Producto[] = [];
  carrito: Producto[] = [];
  mostrarCarrito: boolean = false;
  mostrarImagenModal: boolean = false;
  imagenModalSrc: string = '';
  imagenModalAlt: string = '';
  numeroWhatsApp: string = '524623266568'; // Cambia este nÃºmero por tu WhatsApp
  
  // Estados para carga de Excel
  cargandoProductos: boolean = false;
  errorCarga: string | null = null;
  
  // Subscriptions
  private subscriptions: Subscription = new Subscription();
  
  // Datos dinÃ¡micos desde Excel - se actualiza automÃ¡ticamente
  productosData: ProductosPorCategoria = {};

  constructor(
    private route: ActivatedRoute, 
    private router: Router,
    private catalogoService: CatalogoService
  ) {}
    juguetes: [
      { id: 1, nombre: 'Marvel Spidey', precio: 497.99, imagen: '7887.JPG', descripcion: 'Spidey Amazing friends' },
      { id: 2, nombre: 'Furreal Gogo', precio: 796.99, imagen: '23712.JPG', descripcion: 'FurReal mascota interactiva' },
      { id: 3, nombre: 'MuÃ±eca Fashion', precio: 350.99, imagen: '16431_450.JPG', descripcion: 'MuÃ±eca con accesorios' },
      { id: 4, nombre: 'Set de ConstrucciÃ³n', precio: 485.99, imagen: '91989_485.JPG', descripcion: 'Bloques de construcciÃ³n premium' }
    ],
    ropa: [
      { id: 5, nombre: 'Camiseta Casual', precio: 259.99, imagen: '17292_259JPG.JPG', descripcion: 'Camiseta de algodÃ³n 100%' },
      { id: 6, nombre: 'Sudadera Premium', precio: 370.99, imagen: '74511_370.JPG', descripcion: 'Sudadera cÃ³moda para el invierno' },
      { id: 7, nombre: 'Vestido Elegante', precio: 298.99, imagen: '76355_298.JPG', descripcion: 'Vestido elegante para ocasiones especiales' },
      { id: 8, nombre: 'Conjunto Deportivo', precio: 296.99, imagen: '93541_296.JPG', descripcion: 'Set completo para deportes' }
    ],
    electronica: [
      { id: 9, nombre: 'AudÃ­fonos Bluetooth', precio: 185.99, imagen: '60498_185.JPG', descripcion: 'AudÃ­fonos inalÃ¡mbricos premium' },
      { id: 10, nombre: 'Smart Watch', precio: 350.99, imagen: '81963_350.JPG', descripcion: 'Reloj inteligente multifuncional' },
      { id: 11, nombre: 'Tablet Mini', precio: 249.99, imagen: '6118_249.JPG', descripcion: 'Tablet compacta de alto rendimiento' },
      { id: 12, nombre: 'Cargador PortÃ¡til', precio: 180.99, imagen: '80812_180.JPG', descripcion: 'Power bank de alta capacidad' }
    ],
    hogar: [
      { id: 13, nombre: 'LÃ¡mpara LED Moderna', precio: 185.99, imagen: '71590_185.JPG', descripcion: 'LÃ¡mpara con control inteligente' },
      { id: 14, nombre: 'Difusor AromÃ¡tico', precio: 149.99, imagen: '72702_149.JPG', descripcion: 'Difusor ultrasÃ³nico silencioso' },
      { id: 15, nombre: 'Set de Cocina', precio: 260.99, imagen: '76133_260JPG.JPG', descripcion: 'Utensilios de cocina premium' },
      { id: 16, nombre: 'Organizador Premium', precio: 180.99, imagen: '81261_180.JPG', descripcion: 'Sistema de organizaciÃ³n modular' }
    ],
    deportes: [
      { id: 17, nombre: 'Equipo de Gym', precio: 250.99, imagen: '67764_250.JPG', descripcion: 'Set completo para ejercicio en casa' },
      { id: 18, nombre: 'Botella Deportiva', precio: 150.99, imagen: '18452_150.JPG', descripcion: 'Botella tÃ©rmica deportiva' },
      { id: 19, nombre: 'Kit de Yoga', precio: 180.99, imagen: '71613_180.JPG', descripcion: 'Mat y accesorios para yoga' },
      { id: 20, nombre: 'Pesas Ajustables', precio: 400.99, imagen: '_400.JPG', descripcion: 'Set de pesas con peso ajustable' }
    ]
  };

  constructor(private route: ActivatedRoute, private router: Router) {}

  // Listener para cerrar modal con tecla Escape
  @HostListener('document:keydown', ['$event'])
  handleKeydown(event: KeyboardEvent) {
    if (event.key === 'Escape' && this.mostrarImagenModal) {
      this.cerrarImagenModal();
    }
  }

  ngOnInit(): void {
    this.route.params.subscribe(params => {
      this.categoria = params['categoria'] || 'todas';
      this.cargarProductos();
    });
  }

  cargarProductos(): void {
    if (this.categoria === 'todas') {
      // Mostrar todos los productos
      this.productos = Object.values(this.productosData).flat();
    } else {
      // Mostrar productos de la categorÃ­a especÃ­fica
      this.productos = this.productosData[this.categoria as keyof typeof this.productosData] || [];
    }
  }

  obtenerTituloCategoria(): string {
    const titulos = {
      juguetes: 'Juguetes',
      ropa: 'Ropa y Moda',
      electronica: 'ElectrÃ³nicos',
      hogar: 'Hogar y DecoraciÃ³n',
      deportes: 'Deportes y Fitness',
      todas: 'Todos los Productos'
    };
    return titulos[this.categoria as keyof typeof titulos] || 'CatÃ¡logo';
  }

  obtenerIconoCategoria(): string {
    const iconos = {
      juguetes: 'ðŸ§¸',
      ropa: 'ðŸ‘•',
      electronica: 'ðŸ“±',
      hogar: 'ðŸ¡',
      deportes: 'âš½',
      todas: 'ðŸ›ï¸'
    };
    return iconos[this.categoria as keyof typeof iconos] || 'ðŸ“¦';
  }

  navegarACategoria(categoria: string): void {
    this.router.navigate(['/catalogo', categoria]);
  }

  trackByProducto(index: number, producto: any): number {
    return producto.id;
  }

  onImageError(event: any): void {
    event.target.src = '7887.JPG';
  }

  // MÃ©todos para el modal de imagen
  abrirImagenModal(imagenSrc: string, imagenAlt: string): void {
    this.imagenModalSrc = imagenSrc;
    this.imagenModalAlt = imagenAlt;
    this.mostrarImagenModal = true;
    document.body.style.overflow = 'hidden'; // Evitar scroll en el fondo
  }

  cerrarImagenModal(): void {
    this.mostrarImagenModal = false;
    this.imagenModalSrc = '';
    this.imagenModalAlt = '';
    document.body.style.overflow = 'auto'; // Restaurar scroll
  }

  // MÃ©todos del carrito
  agregarAlCarrito(producto: Producto): void {
    const productoExistente = this.carrito.find(item => item.id === producto.id);
    if (!productoExistente) {
      this.carrito.push(producto);
      this.mostrarNotificacion(`${producto.nombre} agregado al carrito`);
    } else {
      this.mostrarNotificacion(`${producto.nombre} ya estÃ¡ en el carrito`);
    }
  }

  eliminarDelCarrito(producto: Producto): void {
    this.carrito = this.carrito.filter(item => item.id !== producto.id);
  }

  toggleCarrito(): void {
    this.mostrarCarrito = !this.mostrarCarrito;
  }

  obtenerTotalCarrito(): number {
    return this.carrito.reduce((total, producto) => total + producto.precio, 0);
  }

  enviarPorWhatsApp(): void {
    if (this.carrito.length === 0) {
      alert('El carrito estÃ¡ vacÃ­o');
      return;
    }

    let mensaje = 'ðŸ›ï¸ *VERABOX - Pedido*\n\n';
    mensaje += 'ðŸ“‹ *Productos seleccionados:*\n\n';
    
    this.carrito.forEach((producto, index) => {
      mensaje += `${index + 1}. *${producto.nombre}*\n`;
      mensaje += `   ðŸ’° Precio: $${producto.precio}\n`;
      mensaje += `   ðŸ“ ${producto.descripcion}\n\n`;
    });

    mensaje += `ðŸ’µ *Total: $${this.obtenerTotalCarrito().toFixed(2)}*\n\n`;
    mensaje += 'ðŸ“ž Por favor, confirma la disponibilidad y el proceso de compra.';

    const mensajeCodificado = encodeURIComponent(mensaje);
    const urlWhatsApp = `https://wa.me/${this.numeroWhatsApp}?text=${mensajeCodificado}`;
    
    window.open(urlWhatsApp, '_blank');
  }

  vaciarCarrito(): void {
    this.carrito = [];
    this.mostrarCarrito = false;
  }

  estaEnCarrito(producto: Producto): boolean {
    return this.carrito.some(item => item.id === producto.id);
  }

  private mostrarNotificacion(mensaje: string): void {
    // Simple notificaciÃ³n - puedes mejorar esto con una biblioteca de notificaciones
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
    notification.textContent = mensaje;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }
}
