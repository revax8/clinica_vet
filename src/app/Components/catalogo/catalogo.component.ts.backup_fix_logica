import { Component, OnInit, HostListener, OnDestroy } from '@angular/core';
import { ActivatedRoute, Router, RouterLink } from '@angular/router';
import { CommonModule } from '@angular/common';
import { CatalogoService, Producto, ProductosPorCategoria } from '../../Services/catalogo.service';
import { Subscription } from 'rxjs';

@Component({
  selector: 'app-catalogo',
  standalone: true,
  imports: [CommonModule, RouterLink],
  templateUrl: './catalogo.component.html',
  styleUrl: './catalogo.component.css'
})
export class CatalogoComponent implements OnInit, OnDestroy {
  categoria: string = '';
  productos: Producto[] = [];
  carrito: Producto[] = [];
  mostrarCarrito: boolean = false;
  mostrarImagenModal: boolean = false;
  imagenModalSrc: string = '';
  imagenModalAlt: string = '';
  numeroWhatsApp: string = '524623266568'; // Cambia este nÃºmero por tu WhatsApp
  
  // Estados para carga de Excel
  cargandoProductos: boolean = true; // Iniciar en true porque la carga comienza automÃ¡ticamente
  errorCarga: string | null = null;
  
  // Subscriptions
  private subscriptions: Subscription = new Subscription();
  
  // Para usar Object.keys en el template
  Object = Object;
  
  // Datos dinÃ¡micos desde Excel - se actualiza automÃ¡ticamente
  productosData: ProductosPorCategoria = {};

  constructor(
    private route: ActivatedRoute, 
    private router: Router,
    private catalogoService: CatalogoService
  ) {}

  // Listener para cerrar modal con tecla Escape
  @HostListener('document:keydown', ['$event'])
  handleKeydown(event: KeyboardEvent) {
    if (event.key === 'Escape' && this.mostrarImagenModal) {
      this.cerrarImagenModal();
    }
  }

  ngOnInit(): void {
    console.log('ğŸ¯ Componente: ngOnInit iniciado');
    console.log('ğŸ¯ Estado inicial cargando:', this.cargandoProductos);
    
    // Suscribirse a cambios de ruta (solo actualiza categorÃ­a)
    this.subscriptions.add(
      this.route.params.subscribe(params => {
        this.categoria = params['categoria'] || 'juguetes';
        console.log('ğŸ¯ Componente: CategorÃ­a cambiada a:', this.categoria);
        // Si ya hay datos disponibles, recargar productos para la nueva categorÃ­a
        if (Object.keys(this.productosData).length > 0) {
          console.log("ğŸ¯ Componente: Recargando productos para nueva categorÃ­a...");
          this.cargarProductos();
        } else {
          console.log("ğŸ¯ Componente: CategorÃ­a actualizada, esperando datos...");
        }
      })
    );

    // Suscribirse a los productos del servicio (Ãºnico punto de carga inicial)
    this.subscriptions.add(
      this.catalogoService.productos$.subscribe(productos => {
        console.log('ğŸ¯ Componente: Productos recibidos del servicio:', Object.keys(productos));
        this.productosData = productos;
        // SIEMPRE cargar productos cuando lleguen datos (inicial + cambios de Excel)
        if (Object.keys(this.productosData).length > 0) {
          console.log("ğŸ¯ Componente: Datos disponibles, cargando productos para categorÃ­a:", this.categoria);
          this.cargarProductos();
        } else {
          console.log("ğŸ¯ Componente: Datos vacÃ­os, esperando...");
        }
      })
    );

    // Suscribirse al estado de carga
    this.subscriptions.add(
      this.catalogoService.cargando$.subscribe(cargando => {
        console.log('ğŸ¯ Componente: Estado de carga recibido:', cargando);
        this.cargandoProductos = cargando;
      })
    );

    // Suscribirse a errores
    this.subscriptions.add(
      this.catalogoService.error$.subscribe(error => {
        console.log('ğŸ¯ Componente: Error recibido:', error);
        this.errorCarga = error;
      })
    );
  }

  ngOnDestroy(): void {
    this.subscriptions.unsubscribe();
  }

  cargarProductos(): void {
    console.log('ğŸ¯ Componente: cargarProductos() - CategorÃ­a:', this.categoria);
    console.log('ğŸ¯ Componente: Datos disponibles:', Object.keys(this.productosData));
    
    if (this.categoria === 'juguetes') {
      // Mostrar todos los productos
      this.productos = Object.values(this.productosData).flat();
      console.log('ğŸ¯ Componente: Cargando TODOS los productos:', this.productos.length);
    } else {
      // Mostrar productos de la categorÃ­a especÃ­fica
      this.productos = this.productosData[this.categoria as keyof typeof this.productosData] || [];
      console.log('ğŸ¯ Componente: Cargando productos de', this.categoria + ':', this.productos.length);
    }
    
    // Mostrar imÃ¡genes de los primeros 3 productos para debug
    this.productos.slice(0, 3).forEach((producto, i) => {
      console.log(`ğŸ¯ Producto ${i+1}: "${producto.nombre}" â†’ imagen: ${producto.imagen}`);
    });
  }

  /**
   * MÃ©todo para recargar manualmente los productos desde Excel
   */

  obtenerTituloCategoria(): string {
    const titulos = {
      juguetes: 'Juguetes',
      ropa: 'Ropa y Moda',
      electronica: 'ElectrÃ³nicos',
      hogar: 'Hogar y DecoraciÃ³n',
      deportes: 'Deportes y Fitness',
      todas: 'Todos los Productos'
    };
    return titulos[this.categoria as keyof typeof titulos] || 'CatÃ¡logo';
  }

  obtenerIconoCategoria(): string {
    const iconos = {
      juguetes: 'ğŸ§¸',
      ropa: 'ğŸ‘•',
      electronica: 'ğŸ“±',
      hogar: 'ğŸ¡',
      deportes: 'âš½',
      todas: 'ğŸ›ï¸'
    };
    return iconos[this.categoria as keyof typeof iconos] || 'ğŸ“¦';
  }

  navegarACategoria(categoria: string): void {
    this.router.navigate(['/catalogo', categoria]);
  }

  trackByProducto(index: number, producto: any): number {
    return producto.id;
  }

    onImageError(event: any): void {
    console.warn('âŒ Error cargando imagen:', event.target.src);
    
    // NO usar imagen de fallback - mostrar placeholder o imagen rota
    // Esto evita mostrar la imagen de otro producto
    event.target.src = 'data:image/svg+xml;base64,' + btoa(`
      <svg width="300" height="200" xmlns="http://www.w3.org/2000/svg">
        <rect width="100%" height="100%" fill="#f3f4f6"/>
        <text x="50%" y="50%" text-anchor="middle" dy="0.3em" font-family="Arial, sans-serif" font-size="14" fill="#9ca3af">
          Imagen no disponible
        </text>
      </svg>
    `);
    
    // Opcional: ocultar la imagen completamente
    // event.target.style.display = 'none';
  }

  // MÃ©todos para el modal de imagen
  abrirImagenModal(imagenSrc: string, imagenAlt: string): void {
    this.imagenModalSrc = imagenSrc;
    this.imagenModalAlt = imagenAlt;
    this.mostrarImagenModal = true;
    document.body.style.overflow = 'hidden'; // Evitar scroll en el fondo
  }

  cerrarImagenModal(): void {
    this.mostrarImagenModal = false;
    this.imagenModalSrc = '';
    this.imagenModalAlt = '';
    document.body.style.overflow = 'auto'; // Restaurar scroll
  }

  // MÃ©todos del carrito
  agregarAlCarrito(producto: Producto): void {
    const productoExistente = this.carrito.find(item => item.id === producto.id);
    if (!productoExistente) {
      this.carrito.push(producto);
      this.mostrarNotificacion(`${producto.nombre} agregado al carrito`);
    } else {
      this.mostrarNotificacion(`${producto.nombre} ya estÃ¡ en el carrito`);
    }
  }

  eliminarDelCarrito(producto: Producto): void {
    this.carrito = this.carrito.filter(item => item.id !== producto.id);
  }

  toggleCarrito(): void {
    this.mostrarCarrito = !this.mostrarCarrito;
  }

  obtenerTotalCarrito(): number {
    return this.carrito.reduce((total, producto) => total + producto.precio, 0);
  }

  enviarPorWhatsApp(): void {
    if (this.carrito.length === 0) {
      alert('El carrito estÃ¡ vacÃ­o');
      return;
    }

    let mensaje = 'ğŸ›ï¸ *VERABOX - Pedido*\n\n';
    mensaje += 'ğŸ“‹ *Productos seleccionados:*\n\n';
    
    this.carrito.forEach((producto, index) => {
      mensaje += `${index + 1}. *${producto.nombre}*\n`;
      mensaje += `   ğŸ’° Precio: $${producto.precio}\n`;
      mensaje += `   ğŸ“ ${producto.descripcion}\n\n`;
    });

    mensaje += `ğŸ’µ *Total: $${this.obtenerTotalCarrito().toFixed(2)}*\n\n`;
    mensaje += 'ğŸ“ Por favor, confirma la disponibilidad y el proceso de compra.';

    const mensajeCodificado = encodeURIComponent(mensaje);
    const urlWhatsApp = `https://wa.me/${this.numeroWhatsApp}?text=${mensajeCodificado}`;
    
    window.open(urlWhatsApp, '_blank');
  }

  vaciarCarrito(): void {
    this.carrito = [];
    this.mostrarCarrito = false;
  }

  estaEnCarrito(producto: Producto): boolean {
    return this.carrito.some(item => item.id === producto.id);
  }

  private mostrarNotificacion(mensaje: string): void {
    // Simple notificaciÃ³n - puedes mejorar esto con una biblioteca de notificaciones
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300';
    notification.textContent = mensaje;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }
}
